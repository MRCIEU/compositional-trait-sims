---
title: "Compositional trait MVMR"
output: html_notebook
---

```{r}
library(simulateGP)
library(tidyverse)
library(TwoSampleMR)
```

## Simulation questions
 
- What happens when you do straightforward GWAS of compositional phenotypes and feed into MR?
- What happens when there is measurement error?
  - e.g. 3 traits (buckets) - some of the signal in bucket 1 goes into each of the other two buckets
  - e.g. 3 traits (buckets) - some of the signal in bucket 1 goes into both of the other two buckets


## Compositional phenotypes

Three traits

- Active
- Sleeping
- Sedentary

### Scaling method

Randomly generate each phenotype independently, representing the proportion of time, and then scale so that they add up to 24 hours

```{r}
nsnp_active = 100
nsnp_sleeping = 100
nsnp_sedentary = 100
h2_active = 0.4
h2_sleeping = 0.4
h2_sedentary = 0.4

eff_active <- choose_effects(nsnp_active, h2_active)
eff_sleeping <- choose_effects(nsnp_sleeping, h2_sleeping)
eff_sedentary <- choose_effects(nsnp_sedentary, h2_sedentary)

geno_active <- make_geno(10000, nsnp_active, 0.5)
geno_sleeping <- make_geno(10000, nsnp_sleeping, 0.5)
geno_sedentary <- make_geno(10000, nsnp_sleeping, 0.5)

y_active <- make_phen(eff_active, geno_active, vy=1, my=8)
y_sleeping <- make_phen(eff_sleeping, geno_sleeping, vy=1, my=8)
y_sedentary <- make_phen(eff_sedentary, geno_sedentary, vy=1, my=8)

geno <- cbind(geno_active, geno_sleeping, geno_sedentary)
phen <- tibble(y_active=y_active, y_sleeping=y_sleeping, y_sedentary=y_sedentary)
dim(geno)
dim(phen)
rm(y_active, y_sleeping, y_sedentary)
```

Scale phenotypes

```{r}
phen_scale <- phen %>%
  mutate(s = y_active + y_sleeping + y_sedentary) %>%
  mutate(y_active = y_active / s * 24, y_sleeping=y_sleeping / s * 24, y_sedentary=y_sedentary / s * 24) %>%
  select(-c(s))
```

Outcome

```{r}
bxy = c(-0.1, -0.1, 0.1)
phen$chd <- make_phen(bxy, phen)
phen_scale$chd <- make_phen(bxy, phen_scale)
hist(phen$chd)
```

MVMR without scaling

```{r}
dat <- make_mvdat(list(phen$y_active, phen$y_sedentary, phen$y_sleeping), phen$chd, geno)
str(dat)
```
```{r}
mv_multiple(dat)
```

MVMR with scaling

```{r}
dat <- make_mvdat(list(phen_scale$y_active, phen_scale$y_sedentary, phen_scale$y_sleeping), phen_scale$chd, geno)
mv_multiple(dat)
```

Straightforward MR

```{r}
dat_active <- get_effs(phen_scale$y_active, phen_scale$chd, geno)
dat_sleeping <- get_effs(phen_scale$y_sleeping, phen_scale$chd, geno)
dat_sedentary <- get_effs(phen_scale$y_sedentary, phen_scale$chd, geno)
mr(dat_active, method="mr_ivw")
mr(dat_sleeping, method="mr_ivw")
mr(dat_sedentary, method="mr_ivw")
```

### Partitioning method

Divide 24 hours into 3 segments, i.e. 2 breakpoints. Each breakpoint has a mean time, and each individual is given a deviation from the mean time.







